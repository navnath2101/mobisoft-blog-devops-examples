pipeline {
  agent any

  environment {
    AWS_REGION = "ap-south-1"
    ECR_REPO = "ACCOUNT_ID.dkr.ecr.ap-south-1.amazonaws.com/myapp"
  }

  stages {

    stage('Clone Code') {
      steps {
        git 'https://github.com/navnath2101/mobisoft-blog-devops-examples.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        sh 'docker build -t myapp .'
      }
    }

    stage('Login to ECR') {
      steps {
        sh '''
        aws ecr get-login-password --region $AWS_REGION |
        docker login --username AWS --password-stdin $ECR_REPO
        '''
      }
    }

    stage('Push Image') {
      steps {
        sh '''
        docker tag myapp:latest $ECR_REPO:latest
        docker push $ECR_REPO:latest
        '''
      }
    }
  }
}
